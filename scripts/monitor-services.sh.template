#!/bin/bash

# note-mcp-server ç›£è¦–ãƒ»è‡ªå‹•å¾©æ—§ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# 24æ™‚é–“365æ—¥ã®å®‰å®šç¨¼åƒã‚’ç¢ºä¿

DOMAIN="your-domain.com"
LOCAL_PORT="3000"
LOG_FILE="$HOME/.cloudflared/monitor.log"
DISCORD_WEBHOOK_URL="${DISCORD_WEBHOOK_URL:-}"  # ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šDiscordé€šçŸ¥ç”¨Webhook URL
PROJECT_PATH="/home/YOUR_USERNAME/noteMCP"     # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®çµ¶å¯¾ãƒ‘ã‚¹

# ãƒ­ã‚°é–¢æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

# é€šçŸ¥é–¢æ•°
notify() {
    local message="$1"
    log "$message"
    
    if [[ -n "$DISCORD_WEBHOOK_URL" ]]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"content\":\"ğŸ¤– note-mcp-server: $message\"}" \
            "$DISCORD_WEBHOOK_URL" 2>/dev/null || true
    fi
}

# ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
check_local_server() {
    if curl -s http://localhost:$LOCAL_PORT/health > /dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# TunnelçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
check_tunnel() {
    if curl -s https://$DOMAIN/health > /dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•
restart_local_server() {
    log "ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ã—ã¾ã™..."
    pkill -f "note-mcp-server-http.js" 2>/dev/null || true
    sleep 3
    cd $PROJECT_PATH
    npm run start:http > /dev/null 2>&1 &
    sleep 5
}

# Tunnelå†èµ·å‹•
restart_tunnel() {
    log "Cloudflare Tunnelã‚’å†èµ·å‹•ã—ã¾ã™..."
    pkill -f cloudflared 2>/dev/null || true
    sleep 5
    cloudflared tunnel run note-mcp > /dev/null 2>&1 &
    sleep 10
}

# ãƒ¡ã‚¤ãƒ³ç›£è¦–ãƒ«ãƒ¼ãƒ—
main() {
    log "=== note-mcp-server ç›£è¦–é–‹å§‹ ==="
    
    while true; do
        # ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
        if ! check_local_server; then
            notify "âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ãŒå¿œç­”ã—ã¾ã›ã‚“"
            restart_local_server
            
            if check_local_server; then
                notify "âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ãŒå¾©æ—§ã—ã¾ã—ãŸ"
            else
                notify "âŒ ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã®å¾©æ—§ã«å¤±æ•—ã—ã¾ã—ãŸ"
                sleep 30
                continue
            fi
        fi
        
        # Tunnelã‚’ãƒã‚§ãƒƒã‚¯
        if ! check_tunnel; then
            notify "âš ï¸ Cloudflare TunnelãŒå¿œç­”ã—ã¾ã›ã‚“"
            restart_tunnel
            
            if check_tunnel; then
                notify "âœ… Cloudflare TunnelãŒå¾©æ—§ã—ã¾ã—ãŸ"
            else
                notify "âŒ Cloudflare Tunnelã®å¾©æ—§ã«å¤±æ•—ã—ã¾ã—ãŸ"
                # DNSã®å•é¡Œã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã€å†è¨­å®šã‚’è©¦è¡Œ
                log "Tunnelã®å†è¨­å®šã‚’è©¦è¡Œã—ã¾ã™..."
                $PROJECT_PATH/scripts/setup-cloudflare-tunnel.sh
            fi
        fi
        
        # æ­£å¸¸æ™‚
        log "âœ… ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™"
        
        # 5åˆ†å¾…æ©Ÿ
        sleep 300
    done
}

# ã‚·ã‚°ãƒŠãƒ«ãƒãƒ³ãƒ‰ãƒ©
trap 'log "=== ç›£è¦–çµ‚äº† ==="; exit 0' SIGTERM SIGINT

# å®Ÿè¡Œ
main "$@"
